document.addEventListener('DOMContentLoaded', function () {
  // Grab elements
  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');
  const step3 = document.getElementById('step3');
  const step4 = document.getElementById('step4');

  const indicator1 = document.getElementById('stepIndicator1');
  const indicator2 = document.getElementById('stepIndicator2');
  const indicator3 = document.getElementById('stepIndicator3');
  const indicator4 = document.getElementById('stepIndicator4');

  const startCancelButton = document.getElementById('startCancelButton');
  const step1NextButton = document.getElementById('step1NextButton');
  const step2BackButton = document.getElementById('step2BackButton');
  const step2NextButton = document.getElementById('step2NextButton');
  const step3BackButton = document.getElementById('step3BackButton');
  const step3NextButton = document.getElementById('step3NextButton');
  const step4BackButton = document.getElementById('step4BackButton');
  const resetButton = document.getElementById('resetButton');
  const downloadResultButton = document.getElementById('downloadResultButton');

  const fmdMessage = document.getElementById('fmdMessage');
  const step1Error = document.getElementById('step1Error');
  const existingContractInfo = document.getElementById('existingContractInfo');
  const notSureInfo = document.getElementById('notSureInfo');
  const resultDisplay = document.getElementById('resultDisplay');

  // State
  let userSelections = {};

  // Step navigation
  function updateStepIndicator(step) {
    [indicator1, indicator2, indicator3, indicator4].forEach(i => i.classList.remove('active'));
    if (step === 1) indicator1.classList.add('active');
    if (step === 2) indicator2.classList.add('active');
    if (step === 3) indicator3.classList.add('active');
    if (step === 4) indicator4.classList.add('active');
  }

  function showStep(step) {
    [step1, step2, step3, step4].forEach(s => { if (s) s.style.display = 'none'; });
    if (step === 1) step1.style.display = 'block';
    if (step === 2) step2.style.display = 'block';
    if (step === 3) step3.style.display = 'block';
    if (step === 4) step4.style.display = 'block';
    updateStepIndicator(step);
  }

  function resetForm() {
    userSelections = {};
    document.getElementById('purchaseType').value = '';
    document.getElementById('exception').value = 'none';

    ['existingContract', 'value', 'specialized', 'singleSource', 'emergency', 'sbsdCertified']
      .forEach(name => {
        const radios = document.getElementsByName(name);
        radios.forEach(r => r.checked = false);
      });

    fmdMessage.style.display = 'none';
    step1Error.style.display = 'none';
    existingContractInfo.style.display = 'none';
    notSureInfo.style.display = 'none';
    resultDisplay.innerHTML = '';

    step1NextButton.disabled = false;
    step1NextButton.innerText = "Next";

    showStep(1);
  }

  // Step 1: Cancel
  startCancelButton.addEventListener('click', resetForm);

  // Step 1: Next
  step1NextButton.addEventListener('click', function () {
    const purchaseType = document.getElementById('purchaseType').value;

    if (!purchaseType) {
      step1Error.style.display = 'block';
      return;
    } else {
      step1Error.style.display = 'none';
    }

    if (purchaseType === 'construction') {
      fmdMessage.style.display = 'block';
      step1NextButton.disabled = true;
      step1NextButton.innerText = "Contact FMD First";
      return;
    } else {
      fmdMessage.style.display = 'none';
      step1NextButton.disabled = false;
      step1NextButton.innerText = "Next";
    }

    userSelections.purchaseType = purchaseType;
    showStep(2);
  });

  // Step 2: Back
  if (step2BackButton) {
    step2BackButton.addEventListener('click', function () {
      showStep(1);
    });
  }

  // Step 2: Next
  if (step2NextButton) {
    step2NextButton.addEventListener('click', function () {
      const existingContractRadios = document.getElementsByName('existingContract');
      let selectedValue = '';
      for (let i = 0; i < existingContractRadios.length; i++) {
        if (existingContractRadios[i].checked) {
          selectedValue = existingContractRadios[i].value;
          break;
        }
      }

      if (!selectedValue) {
        alert('Please select an option.');
        return;
      }

      userSelections.existingContract = selectedValue;
      showStep(3);
    });
  }

  // Step 3: Back
  if (step3BackButton) {
    step3BackButton.addEventListener('click', function () {
      showStep(2);
    });
  }

  // Step 3: Next
  if (step3NextButton) {
    step3NextButton.addEventListener('click', function () {
      const valueSelected = document.querySelector('input[name="value"]:checked');
      const specializedSelected = document.querySelector('input[name="specialized"]:checked');
      const singleSourceSelected = document.querySelector('input[name="singleSource"]:checked');
      const emergencySelected = document.querySelector('input[name="emergency"]:checked');
      const sbsdCertifiedSelected = document.querySelector('input[name="sbsdCertified"]:checked');

      if (!valueSelected || !specializedSelected || !singleSourceSelected || !emergencySelected || !sbsdCertifiedSelected) {
        alert('Please answer all questions.');
        return;
      }

      userSelections.value = valueSelected.value;
      userSelections.specialized = specializedSelected.value;
      userSelections.singleSource = singleSourceSelected.value;
      userSelections.emergency = emergencySelected.value;
      userSelections.sbsdCertified = sbsdCertifiedSelected.value;
      userSelections.exception = document.getElementById('exception').value;

      // Determine procurement method
      let procurementMethod = '';
      let description = '';
      let additionalInfo = '';
      let timeline = '';
      let cooperativeInfo = ''; // only used for existing contract

      if (userSelections.value === 'under10k') {
        procurementMethod = 'Delegated Authority Purchase';
        description = 'For purchases under $10,000, departments have delegated authority to make purchases without involving University Purchasing.';
        additionalInfo = 'Follow normal requisition or PCard rules as appropriate. Do NOT sign vendor documents directly.';
        timeline = 'Timeline: 1–5 business days.';
      } else if (userSelections.existingContract === 'yes') {
        procurementMethod = 'Use Existing Contract';
        description = 'You indicated there is an existing contract that meets your requirements.';
        additionalInfo = 'Contact University Purchasing for assistance with the order process through the existing contract.';
        timeline = 'Timeline: This is typically the fastest procurement method.';
        cooperativeInfo = `
          <h3 class="mt-3">Cooperative Contract Resources:</h3>
          <p>VCU has access to cooperative platforms such as VASCUPP, VHEPC, eVA, VITA, and Pavilion.</p>
        `;
      } else if (userSelections.singleSource === 'yes') {
        procurementMethod = 'Sole Source Procurement';
        description = 'Only one vendor can provide this item/service.';
        additionalInfo = 'Submit a Sole Source Justification Form with your requisition. Procurement will review and approve if it qualifies.';
        timeline = 'Timeline: 5–15 business days.';
      } else if (userSelections.emergency === 'yes') {
        procurementMethod = 'Emergency Procurement';
        description = 'This purchase is flagged as an emergency.';
        additionalInfo = 'Submit a requisition with detailed justification. Procurement will review for approval.';
        timeline = 'Timeline: 1–5 business days (expedited).';
      } else if (userSelections.value === '10kTo200k') {
        if (userSelections.specialized === 'yes') {
          procurementMethod = 'Best Value Acquisition (BVA)';
          description = 'For specialized purchases in this range, a BVA evaluates best overall value, not just price.';
          additionalInfo = 'Submit a requisition in RealSource. Procurement will manage the process.';
          timeline = 'Timeline: 15–60+ days.';
        } else {
          procurementMethod = 'Request for Quote (RFQ)';
          description = 'For standard items/services in this range, award is based on lowest price.';
          additionalInfo = 'Submit a requisition in RealSource. Procurement will manage the RFQ process.';
          timeline = 'Timeline: 5–15+ days.';
        }
      } else if (userSelections.value === '200kTo2m' || userSelections.value === '2mTo5m' || userSelections.value === 'over5m') {
        procurementMethod = 'Request for Proposal (RFP)';
        description = 'For purchases over $200,000, an RFP allows evaluation based on multiple criteria.';
        additionalInfo = 'Submit a requisition in RealSource. Procurement will run the RFP process.';
        timeline = 'Timeline: 90–125+ days.';
      }

      // Build exception info
      let exceptionInfo = '';
      if (userSelections.exception !== 'none') {
        const exceptionElement = document.getElementById('exception');
        const exceptionText = exceptionElement.options[exceptionElement.selectedIndex].text;
        exceptionInfo = `<li><strong>Exception to Competition:</strong> ${exceptionText}</li>`;
      }

      // Final results rendering
      resultDisplay.innerHTML = `
        <h2>${procurementMethod}</h2>
        <p>${description}</p>
        <p>${additionalInfo}</p>
        <p><strong>${timeline}</strong></p>
        <div class="badge mb-3">Suggested Method</div>

        <h3>Key Considerations:</h3>
        <ul>
          <li><strong>Purchase Type:</strong> ${getPurchaseTypeText(userSelections.purchaseType)}</li>
          <li><strong>Existing Contract:</strong> ${getExistingContractText(userSelections.existingContract)}</li>
          <li><strong>Estimated Value:</strong> ${getValueRangeText(userSelections.value)}</li>
          <li><strong>Specialized/Unique:</strong> ${userSelections.specialized === 'yes' ? 'Yes' : 'No'}</li>
          <li><strong>Single Source:</strong> ${userSelections.singleSource === 'yes' ? 'Yes' : 'No'}</li>
          <li><strong>Emergency:</strong> ${userSelections.emergency === 'yes' ? 'Yes' : 'No'}</li>
          <li><strong>SBSD Certified Vendor:</strong> ${userSelections.sbsdCertified === 'yes' ? 'Yes' : 'No'}</li>
          ${exceptionInfo}
        </ul>

        <h3 class="mt-2">Next Steps:</h3>
        <ul>
          <li>Submit a requisition in RealSource</li>
          <li>If vendor is not in RealSource, submit a vendor request</li>
          <li>Contact Procurement Services for documentation and approvals</li>
          <li>Work with Purchasing on solicitation development (if applicable)</li>
        </ul>

        ${cooperativeInfo}
      `;

      showStep(4);
    });
  }

  // Step 4: Back
  if (step4BackButton) {
    step4BackButton.addEventListener('click', function () {
      showStep(3);
    });
  }

  // Step 4: Reset
  if (resetButton) {
    resetButton.addEventListener('click', resetForm);
  }

  // PDF Download
  if (downloadResultButton) {
    downloadResultButton.addEventListener('click', function () {
      try {
        generatePDF();
      } catch (e) {
        alert("PDF generation failed: " + e.message);
      }
    });
  }

  function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const currentDate = new Date().toLocaleDateString();

    try {
      if (typeof vcuLogoBase64 !== 'undefined') {
        doc.addImage(vcuLogoBase64, 'PNG', 77, 10, 56, 20);
      } else {
        throw new Error("Logo not loaded");
      }
    } catch (e) {
      doc.setFontSize(20);
      doc.setTextColor(0, 75, 135);
      doc.text('VCU Procurement Method', 105, 20, { align: 'center' });
    }

    doc.setFontSize(12);
    doc.text(`Generated on: ${currentDate}`, 20, 40);
    doc.text('Procurement results will go here...', 20, 60);

    doc.save('VCU_Procurement_Suggestion.pdf');
  }

  // Helpers
  function getValueRangeText(value) {
    switch (value) {
      case 'under10k': return 'Under $10,000 (Delegated Authority)';
      case '10kTo200k': return '$10,000 to $200,000 (Small Purchase)';
      case '200kTo2m': return '$200,000 to $2 million (Formal Process)';
      case '2mTo5m': return '$2 million to $5 million';
      case 'over5m': return 'Over $5 million (BOV Approval required)';
      default: return 'Not specified';
    }
  }

  function getPurchaseTypeText(type) {
    switch (type) {
      case 'standardGoods': return 'Standard Goods';
      case 'standardServices': return 'Standard Services';
      case 'standardGoodsServices': return 'Standard Goods and Services';
      case 'construction': return 'Construction / Facilities Related';
      default: return 'Not specified';
    }
  }

  function getExistingContractText(value) {
    switch (value) {
      case 'yes': return 'Yes';
      case 'no': return 'No';
      case 'notSure': return 'Not sure';
      default: return 'Not specified';
    }
  }

  // Existing Contract radio toggle
  const existingContractRadios = document.getElementsByName('existingContract');
  for (let i = 0; i < existingContractRadios.length; i++) {
    existingContractRadios[i].addEventListener('change', function () {
      if (this.value === 'yes') {
        existingContractInfo.style.display = 'block';
        notSureInfo.style.display = 'none';
      } else if (this.value === 'notSure') {
        existingContractInfo.style.display = 'none';
        notSureInfo.style.display = 'block';
      } else {
        existingContractInfo.style.display = 'none';
        notSureInfo.style.display = 'none';
      }
    });
  }

  // Start fresh
  resetForm();
});
